{% extends 'base.html' %}
{% block content %}
<div class="row g-4">
  <div class="col-12">
    <div class="d-flex justify-content-between align-items-center">
      <h3 class="mb-0">Mark Your Attendance</h3>
      <div class="text-muted small">
        <i class="bi bi-clock me-1"></i>
        <span id="current-time">{{ current_time|date:"M d, Y H:i:s" }}</span> IST
      </div>
    </div>
  </div>

  <!-- Current Subscription Status -->
  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="card-title">Current Subscription</h5>
        {% if active_sub %}
          <div class="row">
            <div class="col-md-6">
              <p class="mb-1"><strong>Plan:</strong> {{ active_sub.plan.title }}</p>
              <p class="mb-1"><strong>Valid Until:</strong> {{ active_sub.end_date|date:"M d, Y" }}</p>
              <p class="mb-0"><strong>Included Meals:</strong></p>
              <div class="d-flex gap-2 mt-2">
                {% for meal in allowed_meals %}
                  <span class="badge bg-success">{{ meal|title }}</span>
                {% endfor %}
              </div>
            </div>
            <div class="col-md-6">
              <div class="text-end">
                <span class="badge bg-primary fs-6">Active</span>
              </div>
            </div>
          </div>
        {% else %}
          <div class="alert alert-warning">
            <h6 class="alert-heading">No Active Subscription</h6>
            <p class="mb-0">You need an active subscription to mark attendance. <a href="/plans/" class="alert-link">View available plans</a></p>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Today's Attendance -->
  {% if active_sub %}
  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="card-title">Today's Attendance - {{ today|date:"M d, Y" }}</h5>
        <p class="text-muted">Mark your attendance for today's meals</p>
        
        <div class="row g-3">
          {% for meal in allowed_meals %}
          <div class="col-md-4">
            <div class="card border-2 {% if meal in marked_meals %}border-success{% else %}border-light{% endif %}">
              <div class="card-body text-center">
                <div class="mb-3">
                  {% if meal == 'breakfast' %}
                    <i class="bi bi-sunrise text-warning" style="font-size: 2rem;"></i>
                  {% elif meal == 'lunch' %}
                    <i class="bi bi-sun text-warning" style="font-size: 2rem;"></i>
                  {% elif meal == 'dinner' %}
                    <i class="bi bi-moon text-primary" style="font-size: 2rem;"></i>
                  {% endif %}
                </div>
                <h6 class="card-title">{{ meal|title }}</h6>
                {% if meal in marked_meals %}
                  <span class="badge bg-success mb-2">Marked</span>
                  <p class="small text-muted">Already marked for today</p>
                {% else %}
                  <button class="btn btn-outline-primary" onclick="markAttendance('{{ meal }}')">
                    <i class="bi bi-check-circle me-1"></i>Mark Attendance
                  </button>
                {% endif %}
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
        
        {% if not allowed_meals %}
        <div class="alert alert-info">
          <i class="bi bi-info-circle me-2"></i>
          No meals included in your current subscription plan.
        </div>
        {% endif %}
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Recent Attendance History -->
  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="card-title">Recent Attendance History</h5>
        {% if recent_attendance %}
          <div class="table-responsive">
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Meal</th>
                  <th>Marked At</th>
                </tr>
              </thead>
              <tbody>
                {% for att in recent_attendance %}
                <tr>
                  <td>{{ att.date|date:"M d, Y" }}</td>
                  <td>
                    <span class="badge bg-primary">{{ att.meal_type|title }}</span>
                  </td>
                  <td>{{ att.marked_at|date:"H:i:s" }} IST</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="text-muted text-center py-4">
            <i class="bi bi-calendar-x" style="font-size: 2rem;"></i>
            <p class="mt-2">No attendance records found</p>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<script>
// Real-time clock for Kolkata timezone
function updateClock() {
  const now = new Date();
  const kolkataTime = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Kolkata"}));
  
  const timeString = kolkataTime.toLocaleTimeString('en-IN', {
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit',
    hour12: false
  });
  
  const dateString = kolkataTime.toLocaleDateString('en-IN', {
    day: '2-digit',
    month: 'short',
    year: 'numeric'
  });
  
  document.getElementById('current-time').textContent = `${dateString} ${timeString}`;
}

// Update clock every second
setInterval(updateClock, 1000);
updateClock(); // Initial call

async function markAttendance(meal) {
  try {
    const response = await fetch('/api/attendance/mark/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCsrfToken()
      },
      body: JSON.stringify({ meal_type: meal })
    });
    
    const data = await response.json();
    
    if (response.ok) {
      // Show success message
      showAlert('success', `Attendance marked for ${meal}!`);
      // Reload page to update UI
      setTimeout(() => {
        location.reload();
      }, 1500);
    } else {
      showAlert('danger', data.detail || 'Failed to mark attendance');
    }
  } catch (error) {
    console.error('Error:', error);
    showAlert('danger', 'An error occurred while marking attendance');
  }
}

function getCsrfToken() {
  const cookies = document.cookie.split(';');
  for (let cookie of cookies) {
    const [name, value] = cookie.trim().split('=');
    if (name === 'csrftoken') {
      return value;
    }
  }
  return '';
}

function showAlert(type, message) {
  const alertDiv = document.createElement('div');
  alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
  alertDiv.innerHTML = `
    ${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  `;
  
  // Insert at the top of the main content
  const main = document.querySelector('main');
  main.insertBefore(alertDiv, main.firstChild);
  
  // Auto-dismiss after 5 seconds
  setTimeout(() => {
    if (alertDiv.parentNode) {
      alertDiv.remove();
    }
  }, 5000);
}
</script>
{% endblock %}
